---
title: Ego-Planner 规划算法
createTime: 2024/10/20 00:09:27
permalink: /droneKit/Ego-Planner规划算法/
readingTime: false
---

## 环境配置与模块编译

```bash
# 进入 X152b 项目根目录执行
cd X152b
bash src/ego_planner_swarm_v1/setup.sh
```

## 算法使用

:::: steps

- ### 选择合适的场景
    由于相机前置安装，因此无人机仅能检测到前方的障碍物。因此避免设置让无人机大转向后立即避障的场景。

    当障碍物密集时，尤其是钻洞场景，在接近障碍物时需要更多的点以引导无人机尽可能接近，否则无人机可能会在察觉到可用路径前提前绕行，导致最终没有按预想路径飞行。
    <!-- TODO(Derkai): 这里需要更新一个视频对比不同障碍物、膨胀系数的影响 -->
    
- ### 设定航点
    ```bash
    # 打开配置文件，翻到大约第 68 行
    vim /home/emnavi/x152b/src/ego_planner_swarm_v1/src/planner/plan_manage/launch/real_env/swarm_all_in_one.launch
    ```

    预设目标点数默认为5个。如果这里设置2个 (<5)，那就只执行前2个点，后面的目标点都不执行。
    ```xml
    <!-- 预设目标点数 -->
    <arg name="point_num" value="2" /> // [!code focus]
    ```

    这里给出具体每个目标点的坐标：
    ```
    <!-- 目标点为相对里程计初始化点的x、y、z坐标，单位 m -->
    <arg name="point0_x" value="3.0" /> // [!code focus]
    <arg name="point0_y" value="0.0" /> // [!code focus]
    <arg name="point0_z" value="1.3" /> // [!code focus]

    <arg name="point1_x" value="0.0" /> // [!code focus]
    <arg name="point1_y" value="0.0" /> // [!code focus]
    <arg name="point1_z" value="1.3" /> // [!code focus]
    ......
    <!-- 建议最后一个点设置为 0 0 0 -->
    ```

- ### 运行算法
    手持无人机，先启动视觉里程计，再启动 Ego-Planner，即可看到实时规划轨迹结果。
    ```bash
    # 进入 X152b 项目根目录执行
    cd X152b
    # 初始化无人机
    bash scripts/one_shot_single.sh
    # 启动 Vins-Fusion 视觉里程计
    bash src/vins_fusion/run.sh
    # 启动 Ego-Planner 规划算法
    bash src/ego_planner_swarm_v1/run.sh
    ```

::::

::: details 实际飞行时，速度不满意？

设置规划轨迹时允许的最大运行速度和最大加速度
```xml
<arg name="max_vel" default="1" />
<arg name="max_acc" default="1" />
```
:::

::: details 5个目标点不够用，想要设置更多？

待更新，在文件里面修改添加，并重新编译

<!-- 文件里面可以改


    增加更多的点数
    请修改 xxx文件 和 xxx文件，如下示例：
    放一段修改的代码示例 -->
:::

## 常见问题

::: warning Q: 无人机在穿越障碍时会撞到障碍物。

可以通过录制rosbag包离线运行算法或手持无人机到撞机点附近，复现异常场景。可能的原因包含：

1、无人机飞行太快，Ego-Planner 规划结果还未能完全得到执行或里程计延迟太高

2、在撞机点附近的深度图，导致生成的点云占据栅格地图出现非理想情况（生成错误或生成缺失）

通常的做法是先检查相机在撞机点附近的深度图可靠（没有大片空洞或者异常点云）

再考虑调整场地环境（环境灯光、障碍物摆放空间关系）、深度相机参数、点云占据栅格生成参数等来保证该处的规划可行。

:::